---
title: Short-term forecasting of total Number of reported COVID-19 cases in South Africa - A Bayesian temporal modeling approch
author:
  - name: Belay Birlie Yimer
    email: belaybirlie.yimer@manchester.ac.uk
    affiliation: 
    - Arthritis Research UK Centre for Epidemiology, Division of Musculoskeletal and Dermatological Sciences, The University of Manchester, Manchester; 
    - Interuniversity Institute for Biostatistics and statistical Bioinformatics (I-BioStat), Hasselt University, Diepenbeek, Belgium.
    
  - name: Ziv Shkedy
    email: ziv.shkedy@uhasselt.be
    affiliation: 
      - Interuniversity Institute for Biostatistics and statistical Bioinformatics (I-BioStat), Hasselt University, Diepenbeek, Belgium.
abstract: |
  To be updated.
  
author_summary: |
  To be updated.

bibliography: mybibfile.bib
output: rticles::plos_article
csl: plos.csl
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
 \usepackage{float} \floatplacement{figure}{H} 
 \newcommand{\beginsupplement}{\setcounter{table}{0}  
 \renewcommand{\thetable}{S\arabic{table}}     
 \setcounter{figure}{0} 
 \renewcommand{\thefigure}{S\arabic{figure}}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.pos = 'H', tab.pos = 'H')
```

# Introduction

In this paper we present (1) South Africaâ€™s COVID trajectory to the first 100,000 (22 June 2020) cases and (2) fit a series of non-linear growth models, calibrated to COVID-19 cumulative number of reported case data from 5 March 2020 to 22 June 2020. The models are used to produce short term predictions of the number of reported cases expected for a period of 30 days ahead. These forecasts are generated at the national level

# Methods 

## Data 

We downloaded data from Coronavirus COVID-19 (2019-nCoV) Data Repository for South Africa maintained by Data Science for Social Impact research group at the University of Pretoria [ref]. The data repository captures the daily number of new cases, number of tests, number of deaths and recoveries. Our primary outcome of interest was the daily number of newly diagnosed COVID-19 cases and the unit of time used in modelling was a day. We used the daily case reports from March 12, 2020, until February 27, 2021, in our analysis.


## Statistical analysis 
We considered two widely used temporal models to model the daily number of newly diagnosed COVID-19 cases. We let $Y(t)$ denote the daily number of newly diagnosed COVID-19 cases at time $t$ and $\mu(t)$ represent the expected number of cases at time $t$. We considered a Negative binomial distribution for $Y(t)$ to account for possible overdispersion. That is, $Y(t) \sim NB(\mu(t), \delta)$, where $\delta$ is the overdispersion parameter. We considered two temporal models to capture the trend over time: a random walk of order two ($RW(2)$) and an autoregressive model of order one ($AR(1)$) [@gomez2020bayesian]. We also considerd a $RW(1)$ model,  but the model overfits the data (See the supplemntary appendix). Similarly, we considerd an $AR$ model order $p=2$ but the result is similar to $AR1$ model and we prefer the simpler $AR1$ model. 

The $AR(1)$ model [@gomez2020bayesian] is given by, 

$$
\begin{aligned}
 Y(t) &\sim NB(\mu(t), \delta) \ \ t=1, \dots, n,\\
 log(\mu(t)) &= \alpha+u_t, \\
 u_1 &\sim N(0, \tau_u(1-\rho^2)^{-1}),  \\
  u_t &=\rho u_{t-1} +\epsilon_t, \ \ t=2, \dots, n,  \\
  \epsilon_t & \sim N(0, \tau_{\epsilon}),
\end{aligned}
$$
where,  $\alpha$ is an intercept,  $\rho$ a temporal correlation term (with  $|\rho|<1$) and  $\epsilon_t$ is a Gaussian error term with zero mean and precision  $\tau_{\epsilon}$.

Similarly, the $RW(2)$ model [@gomez2020bayesian] is given by, 
$$
\begin{aligned}
 Y(t) &\sim NB(\mu(t), \delta) \ \ t=1, \dots, n,\\
 log(\mu(t)) &= \alpha+u_t, \\
 u_t-2u_{t+1}+u_{t+2} &\sim N(0, \tau_u), \ \ t=2, \dots, n,
\end{aligned}
$$
where $\alpha$ is the intercept term as before and $\tau_u$ is the precison parameter. 

The two models were fitted within the Bayesian framework using *inla* [@martins2013bayesian]. To complete the specification of both models, we assume the following priors. For the $AR(1)$ model, we denote $\theta_1=log(\tau_u(1-\rho^2))$ where $\Gamma(10,100)$ prior is specified for $\theta_1$, and we denote $\theta_2=log\frac{1+\rho}{1-\rho}$ and assume a $N(0, 0.15)$ prior for $\theta$. Similarly, we represent the precison parameter of $RW(1)$, $\tau_u$, as $\theta=log(\tau_u)$ and assume a $\Gamma (10,100)$ prior for $\theta$. 

To assess the models' accuracy in predicting COVID-19 cases, we present the forecast period's actual observed values and the predicted values. Additionally, the model fits were evaluated by using DIC (Deviance information criteria). 

The R-code that we used for our analyses is avaliable at https://github.com/belayb/COVIDincidenceSA/tree/master/COVIDincidenceSA.



# Results 

```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message = FALSE, warning = FALSE}
library(ggplot2)
library(visreg)
library(INLA)
#'library(visibly)
library(tidyverse)
library(gridExtra)
library(ggpubr)
library(patchwork)
library(lubridate)
library(kableExtra)
library(data.table)
library(sfsmisc)
```

```{r message = FALSE, warning = FALSE}
#'------------- Load data 
tests_sa <- read.csv("https://raw.githubusercontent.com/dsfsi/covid19za/master/data/covid19za_timeline_testing.csv",header=TRUE)
cases_sa <- read.csv("https://raw.githubusercontent.com/dsfsi/covid19za/master/data/covid19za_provincial_cumulative_timeline_confirmed.csv",header=TRUE)
#'------------- Prepare the two data sets to merge  
tests_sa<-tests_sa%>%mutate(date2=lubridate::ymd(YYYYMMDD))
cases_sa<-cases_sa%>%mutate(date2=lubridate::ymd(YYYYMMDD))

variable_keep_test<-c("date2","cumulative_tests")
variable_keep_cases<-c("date2","total")

sa_cov_dat<-left_join(cases_sa[,variable_keep_cases], tests_sa[,variable_keep_test], by="date2")
# sa_cov_dat[18:35,] also unknown number of tests on 25-03, and 07-04 
sa_cov_dat<-sa_cov_dat[sa_cov_dat$date2>'2020-03-09'&!is.na(sa_cov_dat$cumulative_tests),]
sa_cov_dat<-sa_cov_dat[sa_cov_dat$date2<'2021-02-28',]#temp


# You need to start from 2020-03-12 in order to properly calaculate daily cases and tests
# Compute daily cases and tests 
sa_cov_dat<-sa_cov_dat%>%mutate(Dialy_cases=-1*(lag(total)-total), Daily_tests=-1*(lag(cumulative_tests)-cumulative_tests))
sa_cov_dat<-sa_cov_dat[-1, ]


```
Figure 1 presents the daily number of reported COVID-19 cases from 12 March 2020 to 27 February 2021.  Similar to elsewhere in the world,  South Africa pass through a two-wave pandemic. The pandemic's first peak was on 07 July 2020, where up to 13944 new COVID-19 cases reported, followed by a second peak in January 2021, where more than 21,000 daily cases reported. 
Figure 2 presents the cumulative number of new reported COVID-19 cases and tests performed. To date, 8,838,937 tests have been conducted, and a total of 1,500,677 cases reported.



```{r daily-cases,out.width = "99%",fig.cap = "Daily number of COVID-19 cases in South Africa from 12/03/2020-27/02/2021."}

p1<-ggplot(sa_cov_dat, aes(x=date2, y=Dialy_cases,group=1))+geom_point()+xlab("Date")+ylab("Daily cases")+theme_bw()
p1

```


```{r cummulative,out.width = "99%",fig.cap = "The cummulative number of COVID-19 cases and Cummulative number of tests in South Africa from 12/03/2020-27/02/2021. Red-line denote the number of cases and blue-line denotes the number of tests."}

dataa<-gather(sa_cov_dat[,c("date2", "total", "cumulative_tests")], Outcome, count, total:cumulative_tests, factor_key=TRUE)
dataa<-dataa %>% 
  mutate(Type = case_when(
    Outcome=="cumulative_tests" ~ 'Tests',
    TRUE ~ 'Cases') )

p2<-ggplot(dataa,aes(x=date2, y=count,group=Type))+
  geom_line(aes(color=Type))+
  xlab("Date")+ylab("Cumulative count")+
theme_bw()+theme(legend.position="none")

p2
#p2<-ggplot(sa_cov_dat, aes(x=date2, y=total,group=1))+geom_line(size = 1.5)+xlab("Date")+ylab("Cummulative cases")+theme_bw()


#p3<-ggplot(sa_cov_dat, aes(x=date2, y=cumulative_tests,group=1))+geom_line(size = 1.5)+xlab("Date")+ylab("Cummulative tests")+theme_bw()

#p1_3<-p1/p2

#p1_3


```



```{r message = FALSE, warning = FALSE}
# Modeling Daily Cases - Negaive Binomial - AR1 and rw2 model - INLA
# crate a new process time column from date2

sa_cov_dat<-sa_cov_dat%>%mutate(time=cumsum(c(0,diff.Date(date2))))
U <- 0.5#1

hyper.prec <- list(theta = list(prior = "pc.prec", param = c(U, 0.75)))#0.01

fomula_ar1<-Dialy_cases ~ 1 + f(time, model = "ar1",
                               hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_ar2<-Dialy_cases ~ 1 + f(time, model = "ar",order=2)

fomula_rw1<-Dialy_cases ~ 1 + f(time, model = "rw1", scale.model = TRUE, 
                              hyper = hyper.prec)
fomula_rw2<-Dialy_cases ~ 1 + f(time, model = "rw2", scale.model = TRUE, 
                              hyper = hyper.prec)

nb.ar1 <- inla(fomula_ar1,                   
               data = sa_cov_dat,
               family = "nbinomial",
               control.predictor = list(compute = TRUE),
               control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.ar2 <- inla(fomula_ar2,                   
               data = sa_cov_dat,
               family = "nbinomial",
               control.predictor = list(compute = TRUE),
               control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.rw1 <- inla(fomula_rw1,                   
               data = sa_cov_dat,
               family = "nbinomial",
               control.predictor = list(compute = TRUE),
               control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))

nb.rw2 <- inla(fomula_rw2,                   
               data = sa_cov_dat,
               family = "nbinomial",
               control.predictor = list(compute = TRUE),
               control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))



newdata_ar1<-cbind(sa_cov_dat[,c("date2","Dialy_cases","time")],nb.ar1$summary.fitted.values)
newdata_ar1 <- reshape:::rename(newdata_ar1, c("0.025quant"="lower", "0.975quant"="upper"))

newdata_ar2<-cbind(sa_cov_dat[,c("date2","Dialy_cases","time")],nb.ar2$summary.fitted.values)
newdata_ar2 <- reshape:::rename(newdata_ar2, c("0.025quant"="lower", "0.975quant"="upper"))

newdata_rw1<-cbind(sa_cov_dat[,c("date2","Dialy_cases","time")],nb.rw1$summary.fitted.values)
newdata_rw1 <- reshape:::rename(newdata_rw1, c("0.025quant"="lower", "0.975quant"="upper"))

newdata_rw2<-cbind(sa_cov_dat[,c("date2","Dialy_cases","time")],nb.rw2$summary.fitted.values)
newdata_rw2 <- reshape:::rename(newdata_rw2, c("0.025quant"="lower", "0.975quant"="upper"))

```


```{r ,out.width = "99%",fig.cap = "Fitted and observed data AR1 model"}
p_ar1_inc<-ggplot(newdata_ar1, 
                  aes(y=mean, x=date2)) +geom_blank()+geom_point(aes(y=Dialy_cases, x=date2)) +
                  geom_ribbon(aes(ymin=lower, ymax=upper), fill='blue', alpha=0.6) +
                  geom_line(aes(y=mean, x=date2)) +xlab("Date")+
                  ylab("Observed and fitted cases")+
                  labs(title = "A" )+
                  theme_bw()

p_ar2_inc<-ggplot(newdata_ar2, 
                  aes(y=mean, x=date2)) +geom_blank()+geom_point(aes(y=Dialy_cases, x=date2)) +
                  geom_ribbon(aes(ymin=lower, ymax=upper), fill='blue', alpha=0.6) +
                  geom_line(aes(y=mean, x=date2)) +xlab("Date")+
                  ylab("Observed and fitted cases")+
                  labs(title = "A" )+
                  theme_bw()

p_rw1_inc<-ggplot(newdata_rw1, aes(y=mean, x=date2)) +
  geom_blank()+
  geom_point(aes(y=Dialy_cases, x=date2)) +
  geom_ribbon(aes(ymin=lower, ymax=upper), fill='blue', alpha=0.6) +
  geom_line(aes(y=mean, x=date2)) +xlab("Date")+ylab("Observed and fitted cases")+
  labs(title = "A" )+
  theme_bw()

p_rw2_inc<-ggplot(newdata_rw2, aes(y=mean, x=date2)) +
  geom_blank()+
  geom_point(aes(y=Dialy_cases, x=date2)) +
  geom_ribbon(aes(ymin=lower, ymax=upper), fill='blue', alpha=0.6) +
  geom_line(aes(y=mean, x=date2)) +xlab("Date")+ylab("Observed and fitted cases")+
  labs(title = "A" )+
  theme_bw()

p_ar1_cum<-newdata_ar1%>%
  mutate(Cumm_fitted=cumsum(mean), Cumm_fitted_lower=cumsum(lower),
         Cumm_fitted_upper=cumsum(upper),Cumm_observed=cumsum(Dialy_cases))%>%
  ggplot(aes(y=Cumm_fitted, x=date2)) +
  geom_blank()+
  geom_point(aes(y=Cumm_observed, x=date2)) +
  geom_ribbon(aes(ymin=Cumm_fitted_lower, ymax=Cumm_fitted_upper), fill='blue', alpha=0.6) +
  geom_line(aes(y=Cumm_fitted, x=date2)) +xlab("Date")+
  ylab("cummulative observed and fitted cases")+
  labs(title = "Negative-Binomial with AR1 model" )+
  theme_bw()
p_rw2_cum<-newdata_rw2%>%
  mutate(Cumm_fitted=cumsum(mean), Cumm_fitted_lower=cumsum(lower),
         Cumm_fitted_upper=cumsum(upper),Cumm_observed=cumsum(Dialy_cases))%>%
  ggplot(aes(y=Cumm_fitted, x=date2)) +
  geom_blank()+
  geom_point(aes(y=Cumm_observed, x=date2)) +
  geom_ribbon(aes(ymin=Cumm_fitted_lower, ymax=Cumm_fitted_upper), fill='blue', alpha=0.6) +
  geom_line(aes(y=Cumm_fitted, x=date2)) +xlab("Date")+
  ylab("cummulative observed and fitted cases")+
  labs(title = "Negative-Binomial with RW(2) model" )+
  theme_bw()

```



```{r ,out.width = "99%",fig.cap = "Fitted and observed data AR(1) model"}
newdata_ar1$deriv<-D1ss(x=newdata_ar1$time,y=newdata_ar1$mean, spar.off=0.0)
newdata_ar1$L_deriv<-D1ss(x=newdata_ar1$time,y=newdata_ar1$lower, spar.off=0.0)
newdata_ar1$U_deriv<-D1ss(x=newdata_ar1$time,y=newdata_ar1$upper, spar.off=0.0)

p_ar1_inc_deriv_new<-ggplot(newdata_ar1, aes(y=deriv, x=date2)) +
  geom_blank()+
  geom_ribbon(aes(ymin=L_deriv, ymax=U_deriv), fill='blue', alpha=0.6) +
  geom_line(aes(y=deriv, x=date2)) +xlab("Date")+ylab("Derivative")+
  labs(title = "B" )+
  geom_hline(yintercept = 0)+
  theme_bw()

p_ar1_inc/p_ar1_inc_deriv_new

# plot of cummulative overtime
#p_ar1_cum/p_rw2_cum
```

```{r ,out.width = "99%",fig.cap = "Fitted and observed data RW(2) model"}
newdata_rw2$deriv<-D1ss(x=newdata_rw2$time,y=newdata_rw2$mean, spar.off=0.0)
newdata_rw2$L_deriv<-D1ss(x=newdata_rw2$time,y=newdata_rw2$lower, spar.off=0.0)
newdata_rw2$U_deriv<-D1ss(x=newdata_rw2$time,y=newdata_rw2$upper, spar.off=0.0)

p_rw2_inc_deriv_new<-ggplot(newdata_rw2, aes(y=deriv, x=date2)) +
  geom_blank()+
  geom_ribbon(aes(ymin=L_deriv, ymax=U_deriv), fill='blue', alpha=0.6) +
  geom_line(aes(y=deriv, x=date2)) +xlab("Date")+ylab("Derivative")+
  labs(title = "B" )+
  geom_hline(yintercept = 0)+
  theme_bw()

p_rw2_inc/p_rw2_inc_deriv_new

# plot of cummulative overtime
#p_ar1_cum/p_rw2_cum
```
```{r message = FALSE, warning = FALSE}
# Do Forcasting 
sa_cov_dat$Dialy_cases3<-sa_cov_dat$Dialy_cases
sa_cov_dat$Dialy_cases5<-sa_cov_dat$Dialy_cases
sa_cov_dat$Dialy_cases7<-sa_cov_dat$Dialy_cases

sa_cov_dat$Dialy_cases3[sa_cov_dat$time>339]<-NA
sa_cov_dat$Dialy_cases5[sa_cov_dat$time>337]<-NA
sa_cov_dat$Dialy_cases7[sa_cov_dat$time>345]<-NA


fomula_ar1_7<-Dialy_cases7 ~ 1 + f(time, model = "ar1",
                                 hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_rw1_7<-Dialy_cases7 ~ 1 + f(time, model = "rw1", scale.model = TRUE, 
                              hyper = hyper.prec)
fomula_ar2_7<-Dialy_cases7 ~ 1 + f(time, model = "ar",order=2)
fomula_rw2_7<-Dialy_cases7 ~ 1 + f(time, model = "rw2", scale.model = TRUE, 
                              hyper = hyper.prec)

# #nb.ar1_3 <- inla(fomula_ar1_3,                   
#                data = sa_cov_dat,
#                family = "nbinomial",
#                control.predictor = list(compute = TRUE, link = 1),
#                control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
# nb.rw2_3 <- inla(fomula_rw2_3,                   
#                data = sa_cov_dat,
#                family = "nbinomial",
#                control.predictor = list(compute = TRUE, link = 1),
#                control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
# nb.ar1_5 <- inla(fomula_ar1_5,                   
#                  data = sa_cov_dat,
#                  family = "nbinomial",
#                  control.predictor = list(compute = TRUE, link = 1),
#                  control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
# nb.rw2_5 <- inla(fomula_rw2_5,                   
#                  data = sa_cov_dat,
#                  family = "nbinomial",
#                  control.predictor = list(compute = TRUE, link = 1),
#                  control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.ar1_7 <- inla(fomula_ar1_7,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.rw2_7 <- inla(fomula_rw2_7,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.rw1_7 <- inla(fomula_rw1_7,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.ar2_7 <- inla(fomula_ar2_7,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))


nb.rw2_7_pred<-nb.rw2_7$summary.fitted.values[,c(1,3,5)]
nb.ar1_7_pred<-nb.ar1_7$summary.fitted.values[,c(1,3,5)]
nb.rw1_7_pred<-nb.rw1_7$summary.fitted.values[,c(1,3,5)]
nb.ar2_7_pred<-nb.ar2_7$summary.fitted.values[,c(1,3,5)]

nb.rw2_7_pred <- reshape:::rename(nb.rw2_7_pred, c("0.025quant"="rw2_lower", "0.975quant"="rw2_upper","mean"="rw2_mean"))
nb.ar1_7_pred <- reshape:::rename(nb.ar1_7_pred, c("0.025quant"="AR1_lower", "0.975quant"="AR1_upper","mean"="AR1_mean"))
nb.rw1_7_pred <- reshape:::rename(nb.rw1_7_pred, c("0.025quant"="rw1_lower", "0.975quant"="rw1_upper","mean"="rw1_mean"))
nb.ar2_7_pred <- reshape:::rename(nb.ar2_7_pred, c("0.025quant"="AR2_lower", "0.975quant"="AR2_upper","mean"="AR2_mean"))

Day7_pred<-cbind(sa_cov_dat,nb.rw2_7_pred,nb.ar1_7_pred,nb.ar2_7_pred,nb.rw1_7_pred)

#----Present the result as a table as well as plot 
Day7_pred<-Day7_pred%>%
  mutate(Cum_pred_ar1=cumsum(AR1_mean),Cum_pred_ar1_lower=cumsum(AR1_lower),Cum_pred_ar1_upper=cumsum(AR1_upper),
         Cum_pred_rw2=cumsum(rw2_mean),Cum_pred_rw2_lower=cumsum(rw2_lower),Cum_pred_rw2_upper=cumsum(rw2_upper),
         Cum_pred_rw1=cumsum(rw1_mean),Cum_pred_rw1_lower=cumsum(rw1_lower),Cum_pred_rw1_upper=cumsum(rw1_upper),
         Cum_pred_ar2=cumsum(AR2_mean),Cum_pred_ar2_lower=cumsum(AR2_lower),Cum_pred_ar2_upper=cumsum(AR2_upper))

```



## Short-term prediction of the total number of reported COVID-19 cases

We fit the two models described in the previous section to the daily reported new COVID-19 cases. The parameter estimates for the two models are presented in Supplementary Table 1. As depicted in Figure 3, two models fitted to the data appear to fit the observed data (within the estimation period) well with a narrow confidence interval obtained for the $RW(2)$ model.  The two models provides similar predictions over the 7-day ahead period.



```{r message = FALSE, warning = FALSE}
forcast_cum<-Day7_pred%>%
  ggplot(aes(y=total, x=date2)) +
  geom_blank()+
  geom_point(aes(y=total, x=date2)) +
  geom_line(aes(y=Cum_pred_rw2, x=date2),linetype = "dashed", color="red") +
  geom_line(aes(y=Cum_pred_ar1, x=date2),color="blue") +
    geom_line(aes(y=Cum_pred_ar2, x=date2),linetype = "twodash",color="black") +
    geom_line(aes(y=Cum_pred_rw1, x=date2),linetype = "dotted",color="#E69F00") +
    geom_ribbon(aes(ymin=Cum_pred_rw2_lower, ymax=Cum_pred_rw2_upper), fill="#FF00007F", alpha=0.4) +
    geom_ribbon(aes(ymin=Cum_pred_ar1_lower, ymax=Cum_pred_ar1_upper), fill='#0000FF7F', alpha=0.4) +
    geom_ribbon(aes(ymin=Cum_pred_ar2_lower, ymax=Cum_pred_ar2_upper), fill='#0000FF7F', alpha=0.4) +
    geom_ribbon(aes(ymin=Cum_pred_rw1_lower, ymax=Cum_pred_rw1_upper), fill='#0000FF7F', alpha=0.4) +
  xlab("Date")+
  ylab("Cummulative observed and fitted cases")+
  #labs(title = "Negative-Binomial model - 7 days a head forcasting")+
  theme_bw()

forcast_cum<-forcast_cum+annotate("segment", x = as.Date("2020-10-06","%Y-%m-%d"), xend = as.Date("2021-02-06","%Y-%m-%d"), y = 1500000, yend = 1500000,
         colour = "black", size = 1, arrow = arrow())

forcast_cum_zoom<-Day7_pred[Day7_pred$time>336,]%>%
  ggplot(aes(y=total, x=date2)) +
  geom_blank()+
  geom_point(aes(y=total, x=date2)) +
  geom_line(aes(y=Cum_pred_rw2, x=date2),linetype = "dashed", color="red") +
  geom_line(aes(y=Cum_pred_ar1, x=date2),color="blue") +
  geom_line(aes(y=Cum_pred_ar2, x=date2),linetype = "twodash",color="black") +
    geom_line(aes(y=Cum_pred_rw1, x=date2),linetype = "dotted",color="#E69F00") +
  ylab(" ")+
  xlab("Date")+
  theme_bw()

forcast_cum_all<-forcast_cum + inset_element(forcast_cum_zoom, left =0.1, right =0.7, bottom = 0.5, top =0.99)

```

```{r predd,out.width = "99%", fig.cap = "Predicted cummulative COVID-19 cases in South Africa under the RW(1) and AR(1) model. Estimation period 12/03/2020-20/02/2021. The black dots are the observed cummulative cases. The red dashed lines are for RW(2) and the blue line for AR(1).The shaded bands are the prediction intervals. "}

forcast_cum_all

```


```{r message = FALSE, warning = FALSE}
# table 
Frocasting7<-Day7_pred[Day7_pred$time>345,c("date2","total","Cum_pred_rw2", "Cum_pred_rw2_lower", "Cum_pred_rw2_upper"
                                            ,"Cum_pred_ar1", "Cum_pred_ar1_lower", "Cum_pred_ar1_upper",
                                            "Cum_pred_ar2", "Cum_pred_ar2_lower", "Cum_pred_ar2_upper",
                                            "Cum_pred_rw1", "Cum_pred_rw1_lower", "Cum_pred_rw1_upper")]

Frocasting7$Pred_Int_rw2<-paste0("(",round(Frocasting7$Cum_pred_rw2_lower,digits=2), "-", round(Frocasting7$Cum_pred_rw2_upper,digits=2),")")
Frocasting7$Pred_Int_ar1<-paste0("(",round(Frocasting7$Cum_pred_ar1_lower,digits=2), "-", round(Frocasting7$Cum_pred_ar1_upper,digits=2),")")
Frocasting7$Pred_Int_ar2<-paste0("(",round(Frocasting7$Cum_pred_ar2_lower,digits=2), "-", round(Frocasting7$Cum_pred_ar2_upper,digits=2),")")
Frocasting7$Pred_Int_rw1<-paste0("(",round(Frocasting7$Cum_pred_rw1_lower,digits=2), "-", round(Frocasting7$Cum_pred_rw1_upper,digits=2),")")

F1<-Frocasting7[,c("date2","total","Cum_pred_rw2","Pred_Int_rw2")]
F2<-Frocasting7[,c("date2","total","Cum_pred_ar1","Pred_Int_ar1")]
names(F1)<-c("Date","Total","Prediction","Prediction Interval")
names(F2)<-c("Date","Total","Prediction","Prediction Interval")
F3<-Frocasting7[,c("date2","total","Cum_pred_rw1","Pred_Int_rw1")]
F4<-Frocasting7[,c("date2","total","Cum_pred_ar2","Pred_Int_ar2")]
names(F3)<-c("Date","Total","Prediction","Prediction Interval")
names(F4)<-c("Date","Total","Prediction","Prediction Interval")

F1%>%
   mutate(Prediction_error=Total-Prediction)%>%
  rename("Total - Prediction"=Prediction_error)%>%
kable(caption = "Short-term predictions of total number of reported cases at the national level under the rw2 model. Estimation period 12/03/2020-20/02/2021") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")

F2%>%
  mutate(Prediction_error=Total-Prediction)%>%
  rename("Total - Prediction"=Prediction_error)%>%
kable(caption = "Short-term predictions of total number of reported cases at the national level under the AR1 model. Estimation period 12/03/2020-20/02/2021") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")

F3%>%
  mutate(Prediction_error=Total-Prediction)%>%
  rename("Total - Prediction"=Prediction_error)%>%
kable(caption = "Short-term predictions of total number of reported cases at the national level under the RW1 model. Estimation period 12/03/2020-20/02/2021") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")

F4%>%
  mutate(Prediction_error=Total-Prediction)%>%
  rename("Total - Prediction"=Prediction_error)%>%
kable(caption = "Short-term predictions of total number of reported cases at the national level under the AR2 model. Estimation period 12/03/2020-20/02/2021") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")

```


```{r message = FALSE, warning = FALSE}
# table 
Summary_ar1<-round(rbind(nb.ar1$summary.fixed[,c(1,2,3,5)],nb.ar1$summary.hyperpar[,c(1,2,3,5)]),digits=3)
row.names(Summary_ar1)[2]<-"Size"
Summary_ar1%>%
kable(caption = "Parameter estimates AR1 model") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")

Summary_rw2<-round(rbind(nb.rw2$summary.fixed[,c(1,2,3,5)],nb.rw2$summary.hyperpar[,c(1,2,3,5)]),digits=3)
row.names(Summary_rw2)[2]<-"Size"
Summary_rw2%>%
kable(caption = "Parameter estimates RW2 model") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")

IC<-rbind(cbind(nb.ar1$dic$dic, nb.ar1$waic$waic),
cbind(nb.rw2$dic$dic, nb.rw2$waic$waic))
IC<-data.frame(IC)
row.names(IC)<-c("AR1","RW1")
colnames(IC)<-c("DIC","WAIC")

#rownames(IC)<-("AR1","RW2")

IC%>%
kable(caption = "Information Creteria for AR1 and RW2 models") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")


```
## Internal validation 

```{r message = FALSE, warning = FALSE}
# one day a head Forcasting - do this for rw1, ar1,ar2
CV_data<-list()
k=335
for(i in 1:10){
sa_cov_dat$Dialy_cases1<-sa_cov_dat$Dialy_cases
sa_cov_dat$Dialy_cases1[sa_cov_dat$time>(k+i)]<-NA


fomula_rw2_cv<-Dialy_cases1 ~ 1 + f(time, model = "rw2", scale.model = TRUE, 
                              hyper = hyper.prec)
fomula_rw1_cv<-Dialy_cases1 ~ 1 + f(time, model = "rw1", scale.model = TRUE, 
                              hyper = hyper.prec)
fomula_ar1_cv<-Dialy_cases1 ~ 1 + f(time, model = "ar1",
                                 hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_ar2_cv<-Dialy_cases1 ~ 1 + f(time, model = "ar",order=2)

nb.rw1_cv <- inla(fomula_rw1_cv,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))

nb.rw2_cv <- inla(fomula_rw2_cv,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.ar1_cv <- inla(fomula_ar1_cv,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.ar2_cv <- inla(fomula_ar2_cv,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))

nb.rw1_cv_pred<-nb.rw1_cv$summary.fitted.values[,c(1,3,5)]
nb.rw1_cv_pred <- reshape:::rename(nb.rw1_cv_pred, c("0.025quant"="rw1_lower", "0.975quant"="rw1_upper","mean"="rw1_mean"))
nb.rw2_cv_pred<-nb.rw2_cv$summary.fitted.values[,c(1,3,5)]
nb.rw2_cv_pred <- reshape:::rename(nb.rw2_cv_pred, c("0.025quant"="rw2_lower", "0.975quant"="rw2_upper","mean"="rw2_mean"))
nb.ar1_cv_pred<-nb.ar1_cv$summary.fitted.values[,c(1,3,5)]
nb.ar1_cv_pred <- reshape:::rename(nb.ar1_cv_pred, c("0.025quant"="ar1_lower", "0.975quant"="ar1_upper","mean"="ar1_mean"))
nb.ar2_cv_pred<-nb.ar2_cv$summary.fitted.values[,c(1,3,5)]
nb.ar2_cv_pred <- reshape:::rename(nb.ar2_cv_pred, c("0.025quant"="ar2_lower", "0.975quant"="ar2_upper","mean"="ar2_mean"))
CV_pred<-cbind(sa_cov_dat,nb.rw1_cv_pred,nb.rw2_cv_pred,nb.ar1_cv_pred,nb.ar2_cv_pred)

#----Present the result as a table as well as plot 
CV_pred<-CV_pred%>%
  mutate(Cum_pred_rw1=cumsum(rw1_mean),Cum_pred_rw2=cumsum(rw2_mean),Cum_pred_ar1=cumsum(ar1_mean),Cum_pred_ar2=cumsum(ar2_mean))

CV_data[[i]]<-CV_pred

}
One_day_pred<-Two_day_pred<-Three_day_pred<-Four_day_pred<-Five_day_pred<-Six_day_pred<-Seven_day_pred<-NULL
for(i in 1:10){
One_day_pred<-rbind(One_day_pred,CV_data[[i]][CV_data[[i]]$time==k+i+1,c("date2","time","total","Cum_pred_rw1","Cum_pred_rw2","Cum_pred_ar1","Cum_pred_ar2")])
Two_day_pred<-rbind(Two_day_pred,CV_data[[i]][CV_data[[i]]$time==k+i+2,c("date2","time","total","Cum_pred_rw1","Cum_pred_rw2","Cum_pred_ar1","Cum_pred_ar2")])
Three_day_pred<-rbind(Three_day_pred,CV_data[[i]][CV_data[[i]]$time==k+i+3,c("date2","time","total","Cum_pred_rw1","Cum_pred_rw2","Cum_pred_ar1","Cum_pred_ar2")])
Four_day_pred<-rbind(Four_day_pred,CV_data[[i]][CV_data[[i]]$time==k+i+4,c("date2","time","total","Cum_pred_rw1","Cum_pred_rw2","Cum_pred_ar1","Cum_pred_ar2")])
Five_day_pred<-rbind(Five_day_pred,CV_data[[i]][CV_data[[i]]$time==k+i+5,c("date2","time","total","Cum_pred_rw1","Cum_pred_rw2","Cum_pred_ar1","Cum_pred_ar2")])
Six_day_pred<-rbind(Six_day_pred,CV_data[[i]][CV_data[[i]]$time==k+i+6,c("date2","time","total","Cum_pred_rw1","Cum_pred_rw2","Cum_pred_ar1","Cum_pred_ar2")])
Seven_day_pred<-rbind(Seven_day_pred,CV_data[[i]][CV_data[[i]]$time==k+i+7,c("date2","time","total","Cum_pred_rw1","Cum_pred_rw2","Cum_pred_ar1","Cum_pred_ar2")])
}

One_day_pred<-One_day_pred%>%mutate(MAE_rw1=sum(abs(total-Cum_pred_rw1))/10,
                                    MAPE_rw1=sum(abs((total-Cum_pred_rw1)/total))/10,
                                    MAE_rw2=sum(abs(total-Cum_pred_rw2))/10,
                                    MAPE_rw2=sum(abs((total-Cum_pred_rw2)/total))/10,
                                    MAE_ar1=sum(abs(total-Cum_pred_ar1))/10,
                                    MAPE_ar1=sum(abs((total-Cum_pred_ar1)/total))/10,
                                    MAE_ar2=sum(abs(total-Cum_pred_ar2))/10,
                                    MAPE_ar2=sum(abs((total-Cum_pred_ar2)/total))/10)
  

Two_day_pred<-Two_day_pred%>%mutate(MAE_rw1=sum(abs(total-Cum_pred_rw1))/10,
                                    MAPE_rw1=sum(abs((total-Cum_pred_rw1)/total))/10,
                                    MAE_rw2=sum(abs(total-Cum_pred_rw2))/10,
                                    MAPE_rw2=sum(abs((total-Cum_pred_rw2)/total))/10,
                                    MAE_ar1=sum(abs(total-Cum_pred_ar1))/10,
                                    MAPE_ar1=sum(abs((total-Cum_pred_ar1)/total))/10,
                                    MAE_ar2=sum(abs(total-Cum_pred_ar2))/10,
                                    MAPE_ar2=sum(abs((total-Cum_pred_ar2)/total))/10)

Three_day_pred<-Three_day_pred%>%mutate(MAE_rw1=sum(abs(total-Cum_pred_rw1))/10,
                                    MAPE_rw1=sum(abs((total-Cum_pred_rw1)/total))/10,
                                    MAE_rw2=sum(abs(total-Cum_pred_rw2))/10,
                                    MAPE_rw2=sum(abs((total-Cum_pred_rw2)/total))/10,
                                    MAE_ar1=sum(abs(total-Cum_pred_ar1))/10,
                                    MAPE_ar1=sum(abs((total-Cum_pred_ar1)/total))/10,
                                    MAE_ar2=sum(abs(total-Cum_pred_ar2))/10,
                                    MAPE_ar2=sum(abs((total-Cum_pred_ar2)/total))/10)
Four_day_pred<-Four_day_pred%>%mutate(MAE_rw1=sum(abs(total-Cum_pred_rw1))/10,
                                    MAPE_rw1=sum(abs((total-Cum_pred_rw1)/total))/10,
                                    MAE_rw2=sum(abs(total-Cum_pred_rw2))/10,
                                    MAPE_rw2=sum(abs((total-Cum_pred_rw2)/total))/10,
                                    MAE_ar1=sum(abs(total-Cum_pred_ar1))/10,
                                    MAPE_ar1=sum(abs((total-Cum_pred_ar1)/total))/10,
                                    MAE_ar2=sum(abs(total-Cum_pred_ar2))/10,
                                    MAPE_ar2=sum(abs((total-Cum_pred_ar2)/total))/10)
Five_day_pred<-Five_day_pred%>%mutate(MAE_rw1=sum(abs(total-Cum_pred_rw1))/10,
                                    MAPE_rw1=sum(abs((total-Cum_pred_rw1)/total))/10,
                                    MAE_rw2=sum(abs(total-Cum_pred_rw2))/10,
                                    MAPE_rw2=sum(abs((total-Cum_pred_rw2)/total))/10,
                                    MAE_ar1=sum(abs(total-Cum_pred_ar1))/10,
                                    MAPE_ar1=sum(abs((total-Cum_pred_ar1)/total))/10,
                                    MAE_ar2=sum(abs(total-Cum_pred_ar2))/10,
                                    MAPE_ar2=sum(abs((total-Cum_pred_ar2)/total))/10)
Six_day_pred<-Six_day_pred%>%mutate(MAE_rw1=sum(abs(total-Cum_pred_rw1))/10,
                                    MAPE_rw1=sum(abs((total-Cum_pred_rw1)/total))/10,
                                    MAE_rw2=sum(abs(total-Cum_pred_rw2))/10,
                                    MAPE_rw2=sum(abs((total-Cum_pred_rw2)/total))/10,
                                    MAE_ar1=sum(abs(total-Cum_pred_ar1))/10,
                                    MAPE_ar1=sum(abs((total-Cum_pred_ar1)/total))/10,
                                    MAE_ar2=sum(abs(total-Cum_pred_ar2))/10,
                                    MAPE_ar2=sum(abs((total-Cum_pred_ar2)/total))/10)
Seven_day_pred<-Seven_day_pred%>%mutate(MAE_rw1=sum(abs(total-Cum_pred_rw1))/10,
                                    MAPE_rw1=sum(abs((total-Cum_pred_rw1)/total))/10,
                                    MAE_rw2=sum(abs(total-Cum_pred_rw2))/10,
                                    MAPE_rw2=sum(abs((total-Cum_pred_rw2)/total))/10,
                                    MAE_ar1=sum(abs(total-Cum_pred_ar1))/10,
                                    MAPE_ar1=sum(abs((total-Cum_pred_ar1)/total))/10,
                                    MAE_ar2=sum(abs(total-Cum_pred_ar2))/10,
                                    MAPE_ar2=sum(abs((total-Cum_pred_ar2)/total))/10)
collist1<-c("MAE_rw1","MAE_rw2","MAE_ar1","MAE_ar2")
collist2<-c("MAPE_rw1","MAPE_rw2","MAPE_ar1","MAPE_ar2")

Performance_tab1<-rbind(One_day_pred[1,collist1],Two_day_pred[1,collist1],Three_day_pred[1,collist1],Four_day_pred[1,collist1],Five_day_pred[1,collist1],Six_day_pred[1,collist1],Seven_day_pred[1,collist1])
Performance_tab1<-data.frame(Performance_tab1)
row.names(Performance_tab1)<-c("One day","Two day","Three day","Four day","Five day", "Six day", "Seven day")
colnames(Performance_tab1)<-c("MAE RW1","MAE RW2","MAE AR1","MAE AR2")

Performance_tab2<-rbind(One_day_pred[1,collist2],Two_day_pred[1,collist2],Three_day_pred[1,collist2],Four_day_pred[1,collist2],Five_day_pred[1,collist2],Six_day_pred[1,collist2],Seven_day_pred[1,collist2])
Performance_tab2<-data.frame(Performance_tab2)
row.names(Performance_tab2)<-c("One day","Two day","Three day","Four day","Five day", "Six day", "Seven day")
colnames(Performance_tab2)<-c("MAPE RW1","MAPE RW2","MAPE AR1","MAPE AR2")


Performance_tab1%>%
kable(caption = "Accuracy metrics of forecasting for AR1, AR2, RW1, and RW2 models for 1-7 days forcasting.") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")
Performance_tab2%>%
kable(caption = "Accuracy metrics of forecasting for AR1, AR2, RW1, and RW2 models for 1-7 days forcasting.") %>%
kable_classic_2(full_width = F)%>%
  kableExtra::kable_styling(latex_options = "hold_position")



```

```{r accuracy,out.width = "99%", fig.cap = "Predicted vs observed cummulative COVID-19 cases in South Africa under the RW(2) model. Base estimation period 12/03/2020-10/02/2021. The estimation period was expanded by 1 day until 20/02/2021"}
p1<-ggplot(One_day_pred, aes(x=total, y=Cum_pred_rw2))+geom_point()+
  xlab("Observed (t+1)")+ylab("Predicted (t+1)")+
  geom_abline(intercept = 0) + xlim(min(c( One_day_pred$total, One_day_pred$Cum_pred_rw2))-1500, max(c( One_day_pred$total,   One_day_pred$Cum_pred_rw2))+1500)+
  ylim(min(c( One_day_pred$total, One_day_pred$Cum_pred_rw2))-1500, max(c( One_day_pred$total, One_day_pred$Cum_pred_rw2))+1500)

p2<-ggplot(Two_day_pred, aes(x=total, y=Cum_pred_rw2))+geom_point()+
  xlab("Observed (t+2)")+ylab("Predicted (t+2)")+
  geom_abline(intercept = 0) + xlim(min(c( Two_day_pred$total, Two_day_pred$Cum_pred_rw2))-1500, max(c( Two_day_pred$total, Two_day_pred$Cum_pred_rw2))+1500)+
  ylim(min(c( Two_day_pred$total, Two_day_pred$Cum_pred_rw2))-1500, max(c( Two_day_pred$total, Two_day_pred$Cum_pred_rw2))+1500)
p3<-ggplot(Three_day_pred, aes(x=total, y=Cum_pred_rw2))+geom_point()+
  xlab("Observed (t+3)")+ylab("Predicted (t+3)")+
  geom_abline(intercept = 0) + xlim(min(c( Three_day_pred$total, Three_day_pred$Cum_pred_rw2))-1500, max(c( Three_day_pred$total, Three_day_pred$Cum_pred_rw2))+1500)+
  ylim(min(c( Three_day_pred$total, Three_day_pred$Cum_pred_rw2))-1500, max(c( Three_day_pred$total, Three_day_pred$Cum_pred_rw2))+1500)

p4<-ggplot(Four_day_pred, aes(x=total, y=Cum_pred_rw2))+geom_point()+
  xlab("Observed (t+4)")+ylab("Predicted (t+4)")+
  geom_abline(intercept = 0) + xlim(min(c( Four_day_pred$total, Four_day_pred$Cum_pred_rw2))-1500, max(c( Four_day_pred$total, Four_day_pred$Cum_pred_rw2))+1500)+
  ylim(min(c( Four_day_pred$total, Four_day_pred$Cum_pred_rw2))-1500, max(c( Four_day_pred$total, Four_day_pred$Cum_pred_rw2))+1500)

p5<-ggplot(Five_day_pred, aes(x=total, y=Cum_pred_rw2))+geom_point()+
  xlab("Observed (t+5)")+ylab("Predicted (t+5)")+
  geom_abline(intercept = 0) + xlim(min(c( Five_day_pred$total, Five_day_pred$Cum_pred_rw2))-1500, max(c( Five_day_pred$total, Five_day_pred$Cum_pred_rw2))+1500)+
  ylim(min(c( Five_day_pred$total, Five_day_pred$Cum_pred_rw2))-1500, max(c( Five_day_pred$total, Five_day_pred$Cum_pred_rw2))+1500)

p6<-ggplot(Six_day_pred, aes(x=total, y=Cum_pred_rw2))+geom_point()+
  xlab("Observed (t+6)")+ylab("Predicted (t+6)")+
  geom_abline(intercept = 0) + xlim(min(c( Six_day_pred$total, Six_day_pred$Cum_pred_rw2))-1500, max(c( Six_day_pred$total, Six_day_pred$Cum_pred_rw2))+1500)+
  ylim(min(c( Six_day_pred$total, Six_day_pred$Cum_pred_rw2))-1500, max(c( Six_day_pred$total, Six_day_pred$Cum_pred_rw2))+1500)

p7<-ggplot(Seven_day_pred, aes(x=total, y=Cum_pred_rw2))+geom_point()+
  xlab("Observed (t+7)")+ylab("Predicted (t+7)")+
  geom_abline(intercept = 0) + xlim(min(c( Seven_day_pred$total, Seven_day_pred$Cum_pred_rw2))-1500, max(c( Seven_day_pred$total, Seven_day_pred$Cum_pred_rw2))+1500)+
  ylim(min(c( Seven_day_pred$total, Seven_day_pred$Cum_pred_rw2))-1500, max(c( Seven_day_pred$total, Seven_day_pred$Cum_pred_rw2))+1500)

(p1+p3)/(p5+p7)



```



\newpage

# Appendix 
\beginsupplement

```{r ,out.width = "99%",fig.cap = "Fitted and observed data AR(2) model"}
newdata_ar2$deriv<-D1ss(x=newdata_ar2$time,y=newdata_ar2$mean, spar.off=0.0)
newdata_ar2$L_deriv<-D1ss(x=newdata_ar2$time,y=newdata_ar2$lower, spar.off=0.0)
newdata_ar2$U_deriv<-D1ss(x=newdata_ar2$time,y=newdata_ar2$upper, spar.off=0.0)

p_ar2_inc_deriv_new<-ggplot(newdata_ar2, aes(y=deriv, x=date2)) +
  geom_blank()+
  geom_ribbon(aes(ymin=L_deriv, ymax=U_deriv), fill='blue', alpha=0.6) +
  geom_line(aes(y=deriv, x=date2)) +xlab("Date")+ylab("Derivative")+
  labs(title = "Derivative of the smooth Curve" )+
  geom_hline(yintercept = 0)+
  theme_bw()

p_ar2_inc/p_ar2_inc_deriv_new

# plot of cummulative overtime
#p_ar1_cum/p_rw2_cum
```

```{r ,out.width = "99%",fig.cap = "Fitted and observed data RW(1) model"}
newdata_rw1$deriv<-D1ss(x=newdata_rw1$time,y=newdata_rw1$mean, spar.off=0.0)
newdata_rw1$L_deriv<-D1ss(x=newdata_rw1$time,y=newdata_rw1$lower, spar.off=0.0)
newdata_rw1$U_deriv<-D1ss(x=newdata_rw1$time,y=newdata_rw1$upper, spar.off=0.0)

p_rw1_inc_deriv_new<-ggplot(newdata_rw1, aes(y=deriv, x=date2)) +
  geom_blank()+
  geom_ribbon(aes(ymin=L_deriv, ymax=U_deriv), fill='blue', alpha=0.6) +
  geom_line(aes(y=deriv, x=date2)) +xlab("Date")+ylab("Derivative")+
  labs(title = "B" )+
  geom_hline(yintercept = 0)+
  theme_bw()

p_rw1_inc/p_rw1_inc_deriv_new

# plot of cummulative overtime
#p_ar1_cum/p_rw2_cum
```

# References {#references .unnumbered}
