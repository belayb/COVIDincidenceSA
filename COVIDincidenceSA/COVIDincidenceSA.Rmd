---
title: Short-term real-time prediction of total number of reported COVID-19 cases in South Africa - A Bayesian  Temporal Modeling Approch
author:
  - name: Belay Birlie Yimer
    email: belaybirlie.yimer@manchester.ac.uk
    affiliation: 
    - University of Manchester, Uk; 
    - Hasselt University, Belgium.
    corresponding: belaybirlie.yimer@manchester.ac.uk
  - name: Ziv Shkedy
    email: ziv.shkedy@uhasselt.be
    affiliation: 
      - Hasselt University
address:
  - code: Some Institute of Technology
    address: Department 1, Street, City, State, Zip
  - code: Another University
    address: Department 2, Street, City, State, Zip
abstract: |
  To be updated.
  
author_summary: |
  To be updated.

bibliography: mybibfile.bib
output: rticles::plos_article
csl: plos.csl
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

To be updated
Here are two sample references: @Feynman1963118 [@Dirac1953888].

# Methods 

## Data 

We downloaded data from Coronavirus COVID-19 (2019-nCoV) Data Repository for South Africa maintained by Data Science for Social Impact research group at the University of Pretoria [ref]. The data repository captures the daily number of new cases, number of tests, number of deaths and recoveries. Our primary outcome of interest was the daily number of newly diagnosed COVID-19 cases and the unit of time used in modelling was a day. We used the daily case reports from March 12, 2020, until February 15, 2021, in our analysis.


## Statistical analysis 
We considered two widely used temporal models to model the daily number of newly diagnosed COVID-19 cases. We let $Y(t)$ denote the daily number of newly diagnosed COVID-19 cases at time $t$ and $\mu(t)$ represent the expected number of cases at time $t$. We considered a Negative binomial distribution for $Y(t)$ to account for possible overdispersion. That is, $Y(t) \sim NB(\mu(t), \delta)$, where $\delta$ is the overdispersion parameter. We considered two temporal models to capture the trend over time: a random walk of order one ($RW(1)$) and an autoregressive model of order one ($AR(1)$) [ref]. The two models were chosen becuse 

The $AR(1)$ model [ref] is given by, 

$$
\begin{aligned}
 Y(t) &\sim NB(\mu(t), \delta) \ \ t=1, \dots, n,\\
 log(\mu(t)) &= \alpha+u_t, \\
 u_1 &\sim N(0, \tau_u(1-\rho^2)^{-1}),  \\
  u_t &=\rho u_{t-1} +\epsilon_t, \ \ t=2, \dots, n,  \\
  \epsilon_t & \sim N(0, \tau_{\epsilon}),
\end{aligned}
$$
where,  $\alpha$ is an intercept,  $\rho$ a temporal correlation term (with  $|\rho|<1$) and  $\epsilon_t$ is a Gaussian error term with zero mean and precision  $\tau_u$.

Similarly, the $RW(1)$ model [ref] is given by, 
$$
\begin{aligned}
 Y(t) &\sim NB(\mu(t), \delta) \ \ t=1, \dots, n,\\
 log(\mu(t)) &= \alpha+u_t, \\
 u_t-u_{t-1} &\sim N(0, \tau_u), \ \ t=2, \dots, n,
\end{aligned}
$$
where $\alpha$ is the intercept term as before and $\tau_u$ is the precison parameter. 

The two models were fitted within the Bayesian framework using *inla* [ref]. To complete the specification of both models, we assume the following priors. For the $AR(1)$ model, we denote $\theta_1=log(\tau_u(1-\rho^2))$ where $\Gamma(10,100)$ prior is specified for $\theta_1$, and we denote $\theta_2=log\frac{1+\rho}{1-\rho}$ and assume a $N(0, 0.15)$ prior for $\theta$. Similarly, we represent the precison parameter of $RW(1)$, $\tau_u$, as $\theta=log(\tau_u)$ and assume a $\Gamma (10,100)$ prior for $\theta$. To assess the models' accuracy in predicting cases, we present the forecast period's actual observed values and the predicted values.Additionally, the model fits were evaluated by using DIC (Deviance information criteria). The computer code that we used for our analyses is avaliable at https://github.com/belayb/COVIDincidenceSA.



# Results 

```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message = FALSE, warning = FALSE}
library(ggplot2)
library(visreg)
library(INLA)
#'library(visibly)
library(tidyverse)
library(gridExtra)
library(ggpubr)
library(patchwork)
library(lubridate)
library(kableExtra)
library(data.table)
```

```{r message = FALSE, warning = FALSE}
#'------------- Load data 
tests_sa <- read.csv("https://raw.githubusercontent.com/dsfsi/covid19za/master/data/covid19za_timeline_testing.csv",header=TRUE)
cases_sa <- read.csv("https://raw.githubusercontent.com/dsfsi/covid19za/master/data/covid19za_provincial_cumulative_timeline_confirmed.csv",header=TRUE)
#'------------- Prepare the two data sets to merge  
tests_sa<-tests_sa%>%mutate(date2=lubridate::ymd(YYYYMMDD))
cases_sa<-cases_sa%>%mutate(date2=lubridate::ymd(YYYYMMDD))

variable_keep_test<-c("date2","cumulative_tests")
variable_keep_cases<-c("date2","total")

sa_cov_dat<-left_join(cases_sa[,variable_keep_cases], tests_sa[,variable_keep_test], by="date2")
# sa_cov_dat[18:35,] also unknown number of tests on 25-03, and 07-04 
sa_cov_dat<-sa_cov_dat[sa_cov_dat$date2>'2020-03-09'&!is.na(sa_cov_dat$cumulative_tests),]


# You need to start from 2020-03-12 in order to properly calaculate daily cases and tests
# Compute daily cases and tests 
sa_cov_dat<-sa_cov_dat%>%mutate(Dialy_cases=-1*(lag(total)-total), Daily_tests=-1*(lag(cumulative_tests)-cumulative_tests))
sa_cov_dat<-sa_cov_dat[-1, ]

```
Figure 1 (Top panel) presents the daily number of reported COVID-19 cases from 5 March 2020 to 15 February 2021.  Similar to elsewhere in the world,  South Africa pass through a two-wave pandemic. The first peak of the epidemic was on ----, followed by a second peak in January 2021. 
Figure 1 (Bottom Panel) presents the cumulative number of new reported COVID-19 cases and tests performed. To date, 1,353,176 tests have been conducted, corresponding to a testing rate of 22.816 per 1000 population. There was a significant correlation between the number of cases detected and the number of tests performed daily (Rho = 0.7759, p-value< 0.001). 




```{r ,out.width = "99%",fig.cap = "Daily new COVID-19 cases."}

p1<-ggplot(sa_cov_dat, aes(x=date2, y=Dialy_cases,group=1))+geom_point()+xlab("Date")+ylab("Daily cases")+theme_bw()
p1
```

```{r ,out.width = "99%",fig.cap = "cummulative cases and cummulative tests."}

dataa<-gather(sa_cov_dat[,c("date2", "total", "cumulative_tests")], Outcome, count, total:cumulative_tests, factor_key=TRUE)
dataa<-dataa %>% 
  mutate(Type = case_when(
    Outcome=="cumulative_tests" ~ 'Tests',
    TRUE ~ 'Cases') )

p2<-ggplot(dataa,aes(x=date2, y=count,group=Type))+
  geom_line(aes(color=Type))+
  xlab("Date")+ylab("Cumulative count")+
theme_bw()

p2
#p2<-ggplot(sa_cov_dat, aes(x=date2, y=total,group=1))+geom_line(size = 1.5)+xlab("Date")+ylab("Cummulative cases")+theme_bw()


#p3<-ggplot(sa_cov_dat, aes(x=date2, y=cumulative_tests,group=1))+geom_line(size = 1.5)+xlab("Date")+ylab("Cummulative tests")+theme_bw()

#p1_3<-p1/p2

#p1_3


```

```{r message = FALSE, warning = FALSE}
# Modeling Daily Cases - Negaive Binomial - AR1 and RW1 model - INLA
# crate a new process time column from date2

sa_cov_dat<-sa_cov_dat%>%mutate(time=cumsum(c(0,diff.Date(date2))))

fomula_ar1<-Dialy_cases ~ 1 + f(time, model = "ar1",
                               hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_rw1<-Dialy_cases ~ 1 + f(time, model = "rw1",
                               hyper = list(prec = list(param = c(0.1, 0.1))))

nb.ar1 <- inla(fomula_ar1,                   
               data = sa_cov_dat,
               family = "nbinomial",
               control.predictor = list(compute = TRUE),
               control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.rw1 <- inla(fomula_rw1,                   
               data = sa_cov_dat,
               family = "nbinomial",
               control.predictor = list(compute = TRUE),
               control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))



newdata_ar1<-cbind(sa_cov_dat[,c("date2","Dialy_cases")],nb.ar1$summary.fitted.values)
newdata_ar1 <- reshape:::rename(newdata_ar1, c("0.025quant"="lower", "0.975quant"="upper"))
p_ar1_inc<-ggplot(newdata_ar1, 
                  aes(y=mean, x=date2)) +geom_blank()+geom_point(aes(y=Dialy_cases, x=date2)) +
                  geom_ribbon(aes(ymin=lower, ymax=upper), fill='blue', alpha=0.6) +
                  geom_line(aes(y=mean, x=date2)) +xlab("Date")+
                  ylab("Daily observed and fitted cases")+
                  labs(title = "Negative-Binomial with AR(1) model" )+
                  theme_bw()


newdata_rw1<-cbind(sa_cov_dat[,c("date2","Dialy_cases")],nb.rw1$summary.fitted.values)
newdata_rw1 <- reshape:::rename(newdata_rw1, c("0.025quant"="lower", "0.975quant"="upper"))
```

```{r ,out.width = "99%",fig.cap = "Fitted and observed data"}
p_rw1_inc<-ggplot(newdata_rw1, aes(y=mean, x=date2)) +
  geom_blank()+
  geom_point(aes(y=Dialy_cases, x=date2)) +
  geom_ribbon(aes(ymin=lower, ymax=upper), fill='blue', alpha=0.6) +
  geom_line(aes(y=mean, x=date2)) +xlab("Date")+ylab("Daily observed and fitted cases")+
  labs(title = "Negative-Binomial with RW(1) model" )+
  theme_bw()

p_ar1_cum<-newdata_ar1%>%
  mutate(Cumm_fitted=cumsum(mean), Cumm_fitted_lower=cumsum(lower),
         Cumm_fitted_upper=cumsum(upper),Cumm_observed=cumsum(Dialy_cases))%>%
  ggplot(aes(y=Cumm_fitted, x=date2)) +
  geom_blank()+
  geom_point(aes(y=Cumm_observed, x=date2)) +
  geom_ribbon(aes(ymin=Cumm_fitted_lower, ymax=Cumm_fitted_upper), fill='blue', alpha=0.6) +
  geom_line(aes(y=Cumm_fitted, x=date2)) +xlab("Date")+
  ylab("cummulative observed and fitted cases")+
  labs(title = "Negative-Binomial with AR(1) model" )+
  theme_bw()
p_rw1_cum<-newdata_rw1%>%
  mutate(Cumm_fitted=cumsum(mean), Cumm_fitted_lower=cumsum(lower),
         Cumm_fitted_upper=cumsum(upper),Cumm_observed=cumsum(Dialy_cases))%>%
  ggplot(aes(y=Cumm_fitted, x=date2)) +
  geom_blank()+
  geom_point(aes(y=Cumm_observed, x=date2)) +
  geom_ribbon(aes(ymin=Cumm_fitted_lower, ymax=Cumm_fitted_upper), fill='blue', alpha=0.6) +
  geom_line(aes(y=Cumm_fitted, x=date2)) +xlab("Date")+
  ylab("cummulative observed and fitted cases")+
  labs(title = "Negative-Binomial with RW(1) model" )+
  theme_bw()

#plot of incidence over time 
#p_ar1_inc/p_rw1_inc

# plot of cummulative overtime
#p_ar1_cum/p_rw1_cum
```

```{r message = FALSE, warning = FALSE}
# Do Forcasting 
sa_cov_dat$Dialy_cases3<-sa_cov_dat$Dialy_cases
sa_cov_dat$Dialy_cases5<-sa_cov_dat$Dialy_cases
sa_cov_dat$Dialy_cases7<-sa_cov_dat$Dialy_cases

sa_cov_dat$Dialy_cases3[sa_cov_dat$time>339]<-NA
sa_cov_dat$Dialy_cases5[sa_cov_dat$time>337]<-NA
sa_cov_dat$Dialy_cases7[sa_cov_dat$time>335]<-NA

fomula_ar1_3<-Dialy_cases3 ~ 1 + f(time, model = "ar1",
                                hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_rw1_3<-Dialy_cases3 ~ 1 + f(time, model = "rw1",
                                hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_ar1_5<-Dialy_cases5 ~ 1 + f(time, model = "ar1",
                                 hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_rw1_5<-Dialy_cases5 ~ 1 + f(time, model = "rw1",
                                 hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_ar1_7<-Dialy_cases7 ~ 1 + f(time, model = "ar1",
                                 hyper = list(prec = list(param = c(0.1, 0.1))))
fomula_rw1_7<-Dialy_cases7 ~ 1 + f(time, model = "rw1",
                                 hyper = list(prec = list(param = c(0.1, 0.1))))

nb.ar1_3 <- inla(fomula_ar1_3,                   
               data = sa_cov_dat,
               family = "nbinomial",
               control.predictor = list(compute = TRUE, link = 1),
               control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.rw1_3 <- inla(fomula_rw1_3,                   
               data = sa_cov_dat,
               family = "nbinomial",
               control.predictor = list(compute = TRUE, link = 1),
               control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.ar1_5 <- inla(fomula_ar1_5,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.rw1_5 <- inla(fomula_rw1_5,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.ar1_7 <- inla(fomula_ar1_7,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))
nb.rw1_7 <- inla(fomula_rw1_7,                   
                 data = sa_cov_dat,
                 family = "nbinomial",
                 control.predictor = list(compute = TRUE, link = 1),
                 control.compute=list(cpo=TRUE,waic=TRUE,dic=TRUE))

nb.rw1_3_pred<-nb.rw1_3$summary.fitted.values[,c(1,3,5)]
nb.rw1_5_pred<-nb.rw1_5$summary.fitted.values[,c(1,3,5)]
nb.rw1_7_pred<-nb.rw1_7$summary.fitted.values[,c(1,3,5)]
nb.ar1_3_pred<-nb.ar1_3$summary.fitted.values[,c(1,3,5)]
nb.ar1_5_pred<-nb.ar1_5$summary.fitted.values[,c(1,3,5)]
nb.ar1_7_pred<-nb.ar1_7$summary.fitted.values[,c(1,3,5)]

nb.rw1_3_pred <- reshape:::rename(nb.rw1_3_pred, c("0.025quant"="RW1_lower", "0.975quant"="RW1_upper","mean"="RW1_mean"))
nb.ar1_3_pred <- reshape:::rename(nb.ar1_3_pred, c("0.025quant"="AR1_lower", "0.975quant"="AR1_upper","mean"="AR1_mean"))
Day3_pred<-cbind(sa_cov_dat,nb.rw1_3_pred,nb.ar1_3_pred)

nb.rw1_5_pred <- reshape:::rename(nb.rw1_5_pred, c("0.025quant"="RW1_lower", "0.975quant"="RW1_upper","mean"="RW1_mean"))
nb.ar1_5_pred <- reshape:::rename(nb.ar1_5_pred, c("0.025quant"="AR1_lower", "0.975quant"="AR1_upper","mean"="AR1_mean"))
Day5_pred<-cbind(sa_cov_dat,nb.rw1_5_pred,nb.ar1_5_pred)

nb.rw1_7_pred <- reshape:::rename(nb.rw1_7_pred, c("0.025quant"="RW1_lower", "0.975quant"="RW1_upper","mean"="RW1_mean"))
nb.ar1_7_pred <- reshape:::rename(nb.ar1_7_pred, c("0.025quant"="AR1_lower", "0.975quant"="AR1_upper","mean"="AR1_mean"))
Day7_pred<-cbind(sa_cov_dat,nb.rw1_7_pred,nb.ar1_7_pred)

#----Present the result as a table as well as plot 
Day7_pred<-Day7_pred%>%
  mutate(Cum_pred_ar1=cumsum(AR1_mean),Cum_pred_ar1_lower=cumsum(AR1_lower),Cum_pred_ar1_upper=cumsum(AR1_upper),
         Cum_pred_rw1=cumsum(RW1_mean),Cum_pred_rw1_lower=cumsum(RW1_lower),Cum_pred_rw1_upper=cumsum(RW1_upper))
Day5_pred<-Day5_pred%>%
  mutate(Cum_pred_ar1=cumsum(AR1_mean),Cum_pred_ar1_lower=cumsum(AR1_lower),Cum_pred_ar1_upper=cumsum(AR1_upper),
         Cum_pred_rw1=cumsum(RW1_mean),Cum_pred_rw1_lower=cumsum(RW1_lower),Cum_pred_rw1_upper=cumsum(RW1_upper))
Day3_pred<-Day3_pred%>%
  mutate(Cum_pred_ar1=cumsum(AR1_mean),Cum_pred_ar1_lower=cumsum(AR1_lower),Cum_pred_ar1_upper=cumsum(AR1_upper),
         Cum_pred_rw1=cumsum(RW1_mean),Cum_pred_rw1_lower=cumsum(RW1_lower),Cum_pred_rw1_upper=cumsum(RW1_upper))
```

## Short-term prediction of the total number of reported COVID-19 cases
The models described in the previous section were all considered for modeling cumulative cases.The parameter estimates
for the different models are presented in Supplementary Table 1. As mentioned in the previous section, our main interest is to produce a short term forecast for the number of reported cases and deaths. As depicted
from the short-term forecasts for the three models fitted to cases (see Fig. 5, Table 2), all three models appear to fit
the observed data (within the estimation period) well with the 3 parameter and 4 parameter logistic models providing very similar predictions over the 30-day ahead period.

```{r,out.width = "99%", fig.cap = "Fitted and observed data"}
forcast_cum<-Day7_pred%>%
  ggplot(aes(y=total, x=date2)) +
  geom_blank()+
  geom_point(aes(y=total, x=date2)) +
  geom_line(aes(y=Cum_pred_rw1, x=date2),linetype = "dashed", color="red") +
  geom_line(aes(y=Cum_pred_ar1, x=date2),color="blue") +
  xlab("Date")+
  ylab("Cummulative observed and fitted cases")+
  labs(title = "Negative-Binomial model - 7 days a head forcasting")+
  theme_bw()

forcast_cum<-forcast_cum+annotate("segment", x = as.Date("2020-10-06","%Y-%m-%d"), xend = as.Date("2021-02-06","%Y-%m-%d"), y = 1500000, yend = 1500000,
         colour = "blue", size = 1, arrow = arrow())

forcast_cum_zoom<-Day7_pred[Day7_pred$time>324,]%>%
  ggplot(aes(y=total, x=date2)) +
  geom_blank()+
  geom_point(aes(y=total, x=date2)) +
  geom_line(aes(y=Cum_pred_rw1, x=date2),linetype = "dashed", color="red") +
  geom_line(aes(y=Cum_pred_ar1, x=date2),color="blue") +
  ylab(" ")+
  xlab("Date")+
  theme_bw()

forcast_cum_all<-forcast_cum + inset_element(forcast_cum_zoom, left =0.3, right =0.7, bottom = 0.5, top =0.99)
forcast_cum_all
```

```{r message = FALSE, warning = FALSE}
# table 
Frocasting7<-Day7_pred[Day7_pred$time>335,c("date2","total","Cum_pred_rw1", "Cum_pred_rw1_lower", "Cum_pred_rw1_upper"
                                            ,"Cum_pred_ar1", "Cum_pred_ar1_lower", "Cum_pred_ar1_upper")]

Frocasting7$Pred_Int_rw1<-paste0("(",round(Frocasting7$Cum_pred_rw1_lower,digits=2), "-", round(Frocasting7$Cum_pred_rw1_upper,digits=2),")")
Frocasting7$Pred_Int_ar1<-paste0("(",round(Frocasting7$Cum_pred_ar1_lower,digits=2), "-", round(Frocasting7$Cum_pred_ar1_upper,digits=2),")")

F1<-Frocasting7[,c("date2","total","Cum_pred_rw1","Pred_Int_rw1")]
F2<-Frocasting7[,c("date2","total","Cum_pred_ar1","Pred_Int_ar1")]
names(F1)<-c("Date","Total","Prediction","Prediction Interval")
names(F2)<-c("Date","Total","Prediction","Prediction Interval")


F1%>%
kable(caption = "Short-term predictions of total number of reported cases at the national level under the RW1 model. Estimation period 05/03/2020-08/02/2021") %>%
kable_classic_2(full_width = F)

F2%>%
kable(caption = "Short-term predictions of total number of reported cases at the national level under the AR1 model. Estimation period 05/03/2020-08/02/2021") %>%
kable_classic_2(full_width = F)

```





# References {#references .unnumbered}
